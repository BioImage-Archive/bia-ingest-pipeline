/*
 * Nextflow configuration for BIA Ingest Pipeline
 */

// Load environment variables from .env file
params {
    // Directory paths - should be set in .env or via command line
    work_dir_base = env.work_dir_base ?: './work'
    pipeline_dir = env.pipeline_dir ?: '.'
    bia_integrator_dir = env.bia_integrator_dir ?: '../bia-integrator'
    cache_root_dirpath = env.cache_root_dirpath ?: '/tmp/cache'

    // API configuration
    api_target = env.api_target ?: 'prod'
    bia_api_basepath = env.BIA_API_BASEPATH ?: 'https://api.bioimage.io'
    bia_api_username = env.BIA_API_USERNAME ?: ''
    bia_api_password = env.BIA_API_PASSWORD ?: ''

    // Bioformats2raw configuration
    bioformats2raw_bin = env.bioformats2raw_bin ?: ''
    bioformats2raw_java_home = env.bioformats2raw_java_home ?: ''

    // AWS/S3 configuration
    embassy_s3 = env.EMBASSY_S3 ?: ''
    bucket_name = env.bucket_name ?: ''
    aws_access_key_id = env.AWS_ACCESS_KEY_ID ?: ''
    aws_secret_access_key = env.AWS_SECRET_ACCESS_KEY ?: ''
    aws_request_checksum_calculation = env.AWS_REQUEST_CHECKSUM_CALCULATION ?: 'WHEN_REQUIRED'
    aws_response_checksum_validation = env.AWS_RESPONSE_CHECKSUM_VALIDATION ?: 'WHEN_REQUIRED'

    // Slack notification
    slack_recipient = env.to ?: ''

    // Processing parameters
    persistence_mode = 'api'
    max_items = 10
    n_to_ingest = 1000

    // Proposals directory for conversion workflow
    proposals_dir = "${work_dir_base}/proposals_to_convert"
}

// Process-specific resource configuration
process {
    // Default resources
    cpus = 1
    memory = '4 GB'
    time = '2h'

    // Error handling
    errorStrategy = 'retry'
    maxRetries = 2

    // Process-specific overrides
    withName: 'FIND_STUDIES' {
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }

    withName: 'INGEST_STUDY' {
        cpus = 2
        memory = '8 GB'
        time = '4h'
        maxForks = 10  // Limit parallel ingests
    }

    withName: 'PROPOSE_IMAGES' {
        cpus = 1
        memory = '4 GB'
        time = '1h'
        maxForks = 20  // More parallel proposals
    }

    withLabel: 'conversion' {
        cpus = 4
        memory = '16 GB'
        time = '8h'
        maxForks = 5  // Limit concurrent conversions (resource intensive)
    }
}

// Execution profiles
profiles {
    // Local execution (default)
    standard {
        process.executor = 'local'
        process.maxForks = 4
    }

    // SLURM cluster execution
    slurm {
        process {
            executor = 'slurm'
            queue = 'standard'
            clusterOptions = '--account=your_account'

            // SLURM-specific settings
            withName: 'INGEST_STUDY' {
                queue = 'standard'
                time = '4h'
                cpus = 2
                memory = '8 GB'
            }

            withLabel: 'conversion' {
                queue = 'long'
                time = '12h'
                cpus = 8
                memory = '32 GB'
            }
        }
    }

    // Codon-specific profile (your HPC environment)
    codon {
        process {
            executor = 'slurm'
            queue = 'batch'

            beforeScript = 'module load java/17 python/3.11'

            withName: 'INGEST_STUDY' {
                queue = 'batch'
                time = '4h'
                cpus = 2
                memory = '8 GB'
                clusterOptions = '--qos=normal'
            }

            withLabel: 'conversion' {
                queue = 'batch'
                time = '12h'
                cpus = 8
                memory = '32 GB'
                clusterOptions = '--qos=long'
            }
        }
    }

    // Development/testing with reduced parallelism
    dev {
        process.executor = 'local'
        process.maxForks = 2
        params.n_to_ingest = 2
        params.max_items = 2
    }
}

// Workflow execution configuration
executor {
    queueSize = 100
    pollInterval = '30 sec'
    submitRateLimit = '10 sec'
}

// Enable Nextflow reports
report {
    enabled = true
    file = "${params.work_dir}/reports/execution_report.html"
}

timeline {
    enabled = true
    file = "${params.work_dir}/reports/timeline.html"
}

trace {
    enabled = true
    file = "${params.work_dir}/reports/trace.txt"
}

dag {
    enabled = true
    file = "${params.work_dir}/reports/dag.html"
}

// Manifest
manifest {
    name = 'bia-ingest-pipeline'
    author = 'BioImage Archive Team'
    description = 'Nextflow pipeline for ingesting and converting BioImage Archive studies'
    version = '1.0.0'
    nextflowVersion = '>=23.04.0'
}
